# SaveToClipboard - Build automation

default:
    @just --list

# Swift/Xcode バージョン表示
version:
    swift --version
    xcodebuild -version 2>/dev/null || echo "Xcode not found"

# デバッグビルド
build:
    swift build

# リリースビルド
build-release:
    swift build -c release

# .appバンドル作成
app version="0.0.0": clean build-release
    #!/usr/bin/env bash
    set -e
    VERSION="{{ version }}"
    APP_BUNDLE="dist/SaveToClipboard.app"

    mkdir -p "$APP_BUNDLE/Contents/MacOS" "$APP_BUNDLE/Contents/Resources"

    cp .build/release/SaveToClipboard "$APP_BUNDLE/Contents/MacOS/"
    chmod +x "$APP_BUNDLE/Contents/MacOS/SaveToClipboard"
    sed "s/__VERSION__/$VERSION/g" pkg/Info.plist.template > "$APP_BUNDLE/Contents/Info.plist"

# 署名つき.appバンドル作成
app-release version="0.0.0": clean build-release
    #!/usr/bin/env bash
    set -e
    VERSION="{{ version }}"
    APP_BUNDLE="dist/SaveToClipboard.app"
    CERT_NAME="SaveToClipboard Self-Signed"

    mkdir -p "$APP_BUNDLE/Contents/MacOS" "$APP_BUNDLE/Contents/Resources"

    cp .build/release/SaveToClipboard "$APP_BUNDLE/Contents/MacOS/"
    chmod +x "$APP_BUNDLE/Contents/MacOS/SaveToClipboard"
    sed "s/__VERSION__/$VERSION/g" pkg/Info.plist.template > "$APP_BUNDLE/Contents/Info.plist"

    # Find first available codesigning identity from all keychains
    IDENTITY=$(security find-identity -v -p codesigning | grep -E '^\s+[0-9]+\)' | head -1 | sed -E 's/^[^"]*"([^"]+)".*/\1/')

    if [ -n "$IDENTITY" ]; then
        codesign --force --deep --sign "$IDENTITY" "$APP_BUNDLE"
        echo "✅ Signed with certificate: $IDENTITY"
    else
        echo "❌ No codesigning identity found"
        echo "Available certificates:"
        security find-identity -v -p codesigning
        echo ""
        echo "Keychains:"
        security list-keychains
        exit 1
    fi

# DMG作成
dmg version="0.0.0": (app version)
    #!/usr/bin/env bash
    set -e
    VERSION="{{ version }}"
    DMG_NAME="dist/SaveToClipboard-${VERSION}.dmg"
    DMG_TEMP="dist/dmg_temp"

    mkdir -p "$DMG_TEMP"
    cp -R dist/SaveToClipboard.app "$DMG_TEMP/"
    ln -s /Applications "$DMG_TEMP/Applications"

    hdiutil create -volname "SaveToClipboard" -srcfolder "$DMG_TEMP" -ov -format UDZO "$DMG_NAME" > /dev/null
    rm -rf "$DMG_TEMP"

    echo "✅ $DMG_NAME ($(du -h $DMG_NAME | cut -f1))"

# 署名つきDMG作成
dmg-release version="0.0.0": (app-release version)
    #!/usr/bin/env bash
    set -e
    VERSION="{{ version }}"
    DMG_NAME="dist/SaveToClipboard-${VERSION}.dmg"
    DMG_TEMP="dist/dmg_temp"

    mkdir -p "$DMG_TEMP"
    cp -R dist/SaveToClipboard.app "$DMG_TEMP/"
    ln -s /Applications "$DMG_TEMP/Applications"

    hdiutil create -volname "SaveToClipboard" -srcfolder "$DMG_TEMP" -ov -format UDZO "$DMG_NAME" > /dev/null
    rm -rf "$DMG_TEMP"

    echo "✅ $DMG_NAME ($(du -h $DMG_NAME | cut -f1)) [Self-Signed]"

# テストを実行
test:
    swift test

# クリーンアップ
clean:
    rm -rf dist

# バイナリを /Applications にインストール（開発用）
install version="0.0.0": (app version)
    cp -R dist/SaveToClipboard.app /Applications/

# アンインストール
uninstall:
    rm -rf /Applications/SaveToClipboard.app

# 拡張機能IDを設定
configure EXTENSION_ID:
    /Applications/SaveToClipboard.app/Contents/MacOS/SaveToClipboard --configure {{ EXTENSION_ID }}
